# Core DNS & Network Infrastructure
# This stack defines and operates essential network services and Docker networks that all other application stacks depend on.

name: infra

services:
  net-anchor:
    # A tiny container used to "anchor" shared Docker networks so they exist even if
    # no other stacks are currently attached.
    image: alpine:3.20 # Lightweight Alpine Linux image.
    container_name: net-anchor # Fixed name for easy identification.
    command: ["sh", "-c", "sleep infinity"] # Keeps the container running indefinitely.
    restart: unless-stopped # Ensures service restarts if it crashes.
    networks:
      - my-network # Connects to the internal bridge network to give it a 'home'.
      - media-net # Connects to the new media/control-plane network.

networks:
  home-macvlan: # Define the MACVLAN network for direct host network access
    name: home-macvlan
    driver: macvlan # Use the macvlan driver for network isolation
    driver_opts:
      parent: ${NET_NIC_NAME} # Specify the parent network interface from .env file
    ipam: # IP Address Management configuration
      config:
        - subnet: ${NET_IP4_NWADDR} # Define the subnet from .env file
          gateway: ${NET_IP4_DEFGW} # Define the default gateway from .env file
  my-network:
    name: my-network
    driver: bridge # Bridge network for internal service communication

  media-net: # New shared bridge network for the media/control-plane refactor
    name: media-net
    driver: bridge
    